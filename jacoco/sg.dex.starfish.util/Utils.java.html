<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Utils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Starfish - Developer Toolkit for data ecosystems</a> &gt; <a href="index.source.html" class="el_package">sg.dex.starfish.util</a> &gt; <span class="el_source">Utils.java</span></div><h1>Utils.java</h1><pre class="source lang-java linenums">package sg.dex.starfish.util;

import sg.dex.starfish.exception.StarfishValidationException;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.Socket;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.time.Instant;
import java.util.*;

import static sg.dex.starfish.constant.Constant.*;


/**
 * Utility class for StarFish
 * This class has methods for creating random hex string,coerces argument to respective type,
 * check if the resource exist, build default metadata
 *
 * @author Mike
 * @version 0.5
 */
<span class="nc" id="L26">public class Utils {</span>

    /**
     * Length of a DID identifier in bytes
     */
    public static final int DID_LENGTH = 32;
<span class="fc" id="L32">    private static List&lt;String&gt; assetType = new ArrayList&lt;&gt;();</span>

    static {
<span class="fc" id="L35">        assetType.add(BUNDLE);</span>
<span class="fc" id="L36">        assetType.add(OPERATION);</span>
<span class="fc" id="L37">        assetType.add(DATA_SET);</span>

<span class="fc" id="L39">    }</span>

    /**
     * Creates a random hex string of the specified length
     *
     * @param length Number of bytes of hex data to create
     * @return A lowercase hex string of the specified length
     */
    public static String createRandomHexString(int length) {
<span class="fc" id="L48">        SecureRandom sr = new SecureRandom();</span>
<span class="fc" id="L49">        byte[] bytes = new byte[length];</span>
<span class="fc" id="L50">        sr.nextBytes(bytes);</span>
<span class="fc" id="L51">        return Hex.toString(bytes);</span>
    }

    /**
     * Compares two objects for equality. null is considered equal to null.
     *
     * @param a First object
     * @param b Second object
     * @return boolean true if the arguments are equal, false otherwise
     */
    public static boolean equals(Object a, Object b) {
<span class="fc bfc" id="L62" title="All 2 branches covered.">        if (a == null)</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">            return b == null;</span>
<span class="fc" id="L64">        return a.equals(b);</span>
    }

    /**
     * Computes the hashcode for an Object. returns zero for null.
     *
     * @param o Object for which to compute the hashcode
     * @return The computed hashcode
     */
    public static int hashCode(Object o) {
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if (o == null) return 0;</span>
<span class="nc" id="L75">        return o.hashCode();</span>
    }

    /**
     * Gets the class of an object, or null if the argument is null
     *
     * @param o   Any Object
     * @param &lt;T&gt; The class of the Object
     * @return The Class of the argument provided
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public static &lt;T&gt; Class&lt;T&gt; getClass(T o) {
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if (o == null) return null;</span>
<span class="nc" id="L88">        return (Class&lt;T&gt;) o.getClass();</span>
    }

    /**
     * Coerces the argument to a boolean value, where: - null is considered false -
     * Strings &quot;false&quot; and &quot;true&quot; are interpreted appropriately - Boolean values are
     * retained as-is
     *
     * @param o The object to attempt to coerce to a boolean value
     * @return The boolean value of this object if coercion is successful
     */
    public static boolean coerceBoolean(Object o) {
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (o == null) return true;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (o instanceof Boolean) {</span>
<span class="nc" id="L102">            return (Boolean) o;</span>
        }
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (o instanceof String) {</span>
<span class="nc" id="L105">            String s = (String) o;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (s.equals(&quot;true&quot;)) return true;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (s.equals(&quot;false&quot;)) return false;</span>
        }
<span class="nc" id="L109">        throw new IllegalArgumentException(&quot;Can't coerce to boolean: &quot; + o);</span>
    }

    /**
     * Coerces an object to an int value.
     *
     * @param o An object to be converted to an int
     * @return The coerced int value of the object
     */
    public static int coerceInt(Object o) {
<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (o instanceof Number) {</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if (o instanceof Integer) return (Integer) o;</span>
<span class="fc" id="L121">            Number n = (Number) o;</span>
<span class="fc" id="L122">            int value = (int) n.longValue();</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">            if (value != n.doubleValue()) throw new IllegalArgumentException(&quot;Cannot coerce to int without loss:&quot;);</span>
<span class="fc" id="L124">            return value;</span>
        }
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if (o instanceof String) {</span>
<span class="fc" id="L127">            return Integer.parseInt((String) o);</span>
        }
<span class="nc" id="L129">        throw new IllegalArgumentException(&quot;Can't coerce to int: &quot; + o);</span>
    }

    /**
     * Consumes an InputStream to a String assuming UTF-8 encoding
     *
     * @param inputStream the InputStream
     * @return The String value of inputStream
     */
    public static String stringFromStream(InputStream inputStream) {
<span class="fc" id="L139">        ByteArrayOutputStream result = new ByteArrayOutputStream();</span>
<span class="fc" id="L140">        byte[] buffer = new byte[4096];</span>
        int length;
        try {
<span class="fc bfc" id="L143" title="All 2 branches covered.">            while ((length = inputStream.read(buffer)) != -1) {</span>
<span class="fc" id="L144">                result.write(buffer, 0, length);</span>
            }
<span class="nc" id="L146">        } catch (IOException e) {</span>
<span class="nc" id="L147">            throw Utils.sneakyThrow(e);</span>
<span class="fc" id="L148">        }</span>
<span class="fc" id="L149">        return new String(result.toByteArray(), StandardCharsets.UTF_8);</span>
    }

    /**
     * Creates a map using the given arguments as interleaved keys and values
     *
     * @param params one or more argument
     * @param &lt;K&gt;    This describes key parameter
     * @param &lt;V&gt;    This describes value parameter
     * @return A map containing the key keys and values
     * @throws IllegalArgumentException if mapOf has odd number of arguments
     */
    @SuppressWarnings({&quot;unchecked&quot;})
    public static &lt;K, V&gt; Map&lt;K, V&gt; mapOf(Object... params) {
<span class="fc" id="L163">        int len = params.length;</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        if ((len &amp; 1) != 0)</span>
<span class="nc" id="L165">            throw new IllegalArgumentException(&quot;mapOf requires a even number of arguments but got: &quot; + len);</span>
<span class="fc" id="L166">        Map&lt;K, V&gt; result = new HashMap&lt;&gt;(len &gt;&gt; 1);</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">        for (int i = 0; i &lt; len; i += 2) {</span>
<span class="fc" id="L168">            K key = (K) params[i];</span>
<span class="fc" id="L169">            V value = (V) params[i + 1];</span>
<span class="fc" id="L170">            result.put(key, value);</span>
        }
<span class="fc" id="L172">        return result;</span>
    }

    /**
     * Checks if a resource is available
     *
     * @param fileName Name of resource file to query
     * @return true if the resource exists
     */
    public static boolean resourceExists(String fileName) {
<span class="nc" id="L182">        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span>
<span class="nc" id="L183">        URL url = classLoader.getResource(fileName);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">        return (url != null);</span>
    }

    /**
     * Checks HTTP URL and returns &lt;code&gt;true&lt;/code&gt; a connection can be established
     * to the corresponding host and port
     *
     * @param urlString The HTTP URL to be checked.
     * @return boolean if endpoint is up within the timeout
     */
    public static boolean checkURL(String urlString) {
        try {
<span class="nc" id="L196">            URL url = new URL(urlString);</span>
<span class="nc" id="L197">            Socket socket = new Socket(url.getHost(), url.getPort());</span>
<span class="nc" id="L198">            socket.close();</span>
<span class="nc" id="L199">            return true;</span>
<span class="nc" id="L200">        } catch (Exception e) {</span>
<span class="nc" id="L201">            return false;</span>
        }
    }

    /**
     * Creates a default metadata map using:
     * - The current system time
     *
     * @return A HashMap containing the default metadata
     */
    public static HashMap&lt;String, Object&gt; createDefaultMetadata() {
<span class="fc" id="L212">        HashMap&lt;String, Object&gt; ob = new HashMap&lt;&gt;();</span>
<span class="fc" id="L213">        ob.put(DATE_CREATED, Instant.now().toString());</span>
<span class="fc" id="L214">        return ob;</span>
    }

    /**
     * API to validate the meta data mandatory attribute.
     * If any mandatory attribute is missing it will throw StarfishValidationException
     *
     * @param metaData need to be validated
     * @return true if valid metadata
     * @throws StarfishValidationException for exception
     */
    public static boolean validateAssetMetaData(String metaData) {

<span class="fc" id="L227">        Map&lt;String, Object&gt; metaDataMap = JSON.toMap(metaData);</span>

<span class="pc bpc" id="L229" title="1 of 2 branches missed.">        String type = null == metaDataMap.get(&quot;type&quot;) ? null : metaDataMap.get(&quot;type&quot;).toString();</span>

<span class="pc bpc" id="L231" title="2 of 4 branches missed.">        if (type == null || type.isEmpty()) {</span>
<span class="nc" id="L232">            throw new StarfishValidationException(&quot;Type is mandatory for creating Asset.It cannot be null or Empty&quot;);</span>
        }
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">        if (!assetType.contains(type)) {</span>
<span class="nc" id="L235">            throw new StarfishValidationException(&quot;Type is not a valid assetType.It should be operation,bundle,dataset&quot;);</span>
        }


<span class="fc" id="L239">        Set&lt;String&gt; attributeSet = metaDataMap.keySet();</span>

<span class="fc" id="L241">        boolean mandatoryAttributePresent = getMadatoryAttribute().stream().allMatch(attribute -&gt; attributeSet.contains(attribute));</span>

<span class="pc bpc" id="L243" title="1 of 2 branches missed.">        if (!mandatoryAttributePresent) {</span>
<span class="nc" id="L244">            throw new StarfishValidationException(&quot;Not a valid asset metadata, one or few mandatory is missing&quot;);</span>
<span class="pc bpc" id="L245" title="3 of 4 branches missed.">        } else if (type.equals(BUNDLE) &amp;&amp; metaDataMap.get(&quot;contents&quot;) == null) {</span>
<span class="nc" id="L246">            throw new StarfishValidationException(&quot;Mandatory attribute missing : ,contents attribute is mandatory for bundle attribute&quot;);</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        } else if (type.equals(OPERATION)) {</span>
            // for bundle attribute params and results is mandatory
<span class="fc" id="L249">            Map&lt;String, Object&gt; operationMap = JSON.toMap(metaDataMap.get(OPERATION).toString());</span>
<span class="pc bpc" id="L250" title="2 of 4 branches missed.">            if (operationMap.get(PARAMS) == null || operationMap.get(&quot;results&quot;) == null) {</span>
<span class="nc" id="L251">                throw new StarfishValidationException(&quot;Mandatory attribute missing : , either Params or results attribute is missing in operation asset&quot;);</span>
            }
<span class="pc bnc" id="L253" title="All 6 branches missed.">        } else if (type.equals(DATA_SET) &amp;&amp; ((metaDataMap.get(&quot;contentType&quot;) == null) || (metaDataMap.get(&quot;size&quot;) == null))) {</span>
<span class="nc" id="L254">            throw new StarfishValidationException(&quot;Mandatory attribute missing :,either contentType or size  attribute is missing in dataset asset&quot;);</span>
        }

<span class="fc" id="L257">        return true;</span>

    }


    /**
     * API to get the mandatory attribute list
     *
     * @return list of String
     */
    private static List&lt;String&gt; getMadatoryAttribute() {
<span class="fc" id="L268">        List&lt;String&gt; mandatoryList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L269">        mandatoryList.add(&quot;type&quot;);</span>
        //  mandatoryList.add(&quot;name&quot;);
        //mandatoryList.add(&quot;license&quot;);
<span class="fc" id="L272">        mandatoryList.add(&quot;dateCreated&quot;);</span>
        // mandatoryList.add(&quot;author&quot;);
<span class="fc" id="L274">        return mandatoryList;</span>
    }

    /**
     * Helper function to hide checked exceptions
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public static &lt;T extends Throwable&gt; T sneakyThrow(Throwable t) throws T {
<span class="fc" id="L282">        throw (T) t;</span>
    }

    /**
     * Merges two metadata maps.
     *
     * @param a First map to merge
     * @param b Second map to merge
     * @return A new map containing the merged metadata
     */
    public Map&lt;String, Object&gt; mergeMeta(Map&lt;String, Object&gt; a, Map&lt;String, Object&gt; b) {
<span class="nc" id="L293">        HashMap&lt;String, Object&gt; ob = new HashMap&lt;&gt;(a);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (b != null) {</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            for (Map.Entry&lt;String, Object&gt; me : b.entrySet()) {</span>
<span class="nc" id="L296">                ob.put(me.getKey(), me.getValue());</span>
<span class="nc" id="L297">            }</span>
        }
<span class="nc" id="L299">        return ob;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>