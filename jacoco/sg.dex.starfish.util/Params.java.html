<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Params.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Starfish - client library for data ecosystems</a> &gt; <a href="index.source.html" class="el_package">sg.dex.starfish.util</a> &gt; <span class="el_source">Params.java</span></div><h1>Params.java</h1><pre class="source lang-java linenums">package sg.dex.starfish.util;

import org.apache.commons.httpclient.RedirectException;
import sg.dex.starfish.Asset;
import sg.dex.starfish.Operation;
import sg.dex.starfish.exception.StarfishValidationException;
import sg.dex.starfish.impl.remote.RemoteAccount;
import sg.dex.starfish.impl.remote.RemoteAgent;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

/**
 * Utility class for marshalling invokable operation parameters and return values
 */
<span class="nc" id="L17">public class Params {</span>

    /**
     * Creates the &quot;params&quot; part of the invoke payload using the spec in the operation metadata
     * and the passed positional arguments
     *
     * @param operation The operation to format the parameters for
     * @param params    A map of parameter names to assets
     * @return The &quot;params&quot; portion of the invoke payload as a Map
     * @throws IllegalArgumentException if missing required parameter
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public
    static Map&lt;String, Object&gt; formatParams(Operation operation, Map&lt;String, Object&gt; params) {
<span class="nc" id="L31">        HashMap&lt;String, Object&gt; result = new HashMap&lt;&gt;(params.size());</span>
<span class="nc" id="L32">        Map&lt;String, Object&gt; paramSpec = operation.getParamsSpec();</span>
<span class="nc bnc" id="L33" title="All 2 branches missed.">        for (Map.Entry&lt;String, Object&gt; me : paramSpec.entrySet()) {</span>
<span class="nc" id="L34">            String paramName = me.getKey();</span>
<span class="nc" id="L35">            Map&lt;String, Object&gt; spec = (Map&lt;String, Object&gt;) me.getValue();</span>
<span class="nc" id="L36">            String type = (String) spec.get(&quot;type&quot;);</span>
<span class="nc" id="L37">            boolean required = Utils.coerceBoolean(spec.get(&quot;required&quot;));</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">            if (params.containsKey(paramName)) {</span>
<span class="nc" id="L39">                prepareResult(params, result, paramName, type);</span>

            }
            // added additional check so ,if the param is required then
            // it must be present in the params map
            // if required is false then it may or may not present
<span class="nc bnc" id="L45" title="All 4 branches missed.">            if (required &amp;&amp; !result.containsKey(paramName)) {</span>
<span class="nc" id="L46">                throw new IllegalArgumentException(&quot;Parameter &quot; + paramName + &quot; is required but not supplied&quot;);</span>
            }
<span class="nc" id="L48">        }</span>
<span class="nc" id="L49">        return result;</span>
    }

    /**
     * API to prepare required result from a raw result based on metadata of the asset
     *
     * @param params    params
     * @param result    result
     * @param paramName param Name
     * @param type      type
     */
    private static void prepareResult(Map&lt;String, Object&gt; params, HashMap&lt;String, Object&gt; result, String paramName, String type) {
        try {
<span class="nc bnc" id="L62" title="All 2 branches missed.">            if (type.equals(&quot;asset&quot;)) {</span>
                // validate if input is type asset or not
<span class="nc" id="L64">                Asset a = (Asset) params.get(paramName);</span>
<span class="nc" id="L65">                Map&lt;String, Object&gt; value = a.getParamValue();</span>
<span class="nc" id="L66">                result.put(paramName, value);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            } else if (type.equals(&quot;json&quot;)) {</span>

<span class="nc bnc" id="L69" title="All 2 branches missed.">                if (null != params) {</span>
                    //JSON.parse(params.toString());
<span class="nc" id="L71">                    result.put(paramName, params.get(paramName));</span>
                }
            } else {
<span class="nc" id="L74">                throw new StarfishValidationException(&quot;Invalid type of Input .Accepted Input: &quot; +</span>
                        &quot;Asset or Json. Input given: &quot; + type);
            }
<span class="nc" id="L77">        } catch (Exception e) {</span>
<span class="nc" id="L78">            throw new StarfishValidationException(&quot;Invalid type of Input .Accepted Input: &quot; +</span>
                    &quot;Asset or Json. Input given: &quot; + type);
<span class="nc" id="L80">        }</span>
<span class="nc" id="L81">    }</span>

    /**
     * This method is used to format result of the response form Invoke calls.
     * It will map the result data of the response to result defined in the metadata
     * Eg: if the result of the response is type Json ,then it type caste the response to Json
     * if the result of the response is type asset, then it ype caste the response map to asset.
     *
     * @param operation instance reference
     * @param response  response received from the Invoke call
     * @return formatted map of the response received
     */
    public static Map&lt;String, Object&gt; formatResponse(Operation operation, Map&lt;String, Object&gt; response, RemoteAccount remoteAccount) throws IOException {

<span class="nc" id="L95">        HashMap&lt;String, Object&gt; result = new HashMap&lt;&gt;(response.size());</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L97">        Map&lt;String, Object&gt; paramSpec = (Map&lt;String, Object&gt;) operation.getOperationSpec().get(&quot;results&quot;);</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        for (Map.Entry&lt;String, Object&gt; me : paramSpec.entrySet()) {</span>
<span class="nc" id="L100">            String paramName = me.getKey();</span>
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L102">            Map&lt;String, Object&gt; spec = (Map&lt;String, Object&gt;) me.getValue();</span>
<span class="nc" id="L103">            String type = (String) spec.get(&quot;type&quot;);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (response.containsKey(paramName)) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                if (type.equals(&quot;asset&quot;)) {</span>

<span class="nc" id="L107">                    Map&lt;String, Object&gt; didMap = (Map&lt;String, Object&gt;) response.get(paramName);</span>
                    // DID did = DID.create(&quot;op&quot;, (String)didMap.get(&quot;did&quot;), null, null);
<span class="nc" id="L109">                    result.put(paramName, getAsset(didMap.get(&quot;did&quot;), remoteAccount));</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                } else if (type.equals(&quot;json&quot;)) {</span>
<span class="nc" id="L111">                    result.put(paramName, response.get(paramName));</span>
                } else {
<span class="nc" id="L113">                    throw new StarfishValidationException(&quot;Invalid type of Input. Accepted Input: &quot; +</span>
                            &quot;Asset or Json. Input given: &quot; + type);
                }

            }

<span class="nc" id="L119">        }</span>
<span class="nc" id="L120">        return result;</span>

    }

    private static Object getAsset(Object di, RemoteAccount remoteAccount) throws IOException {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (di == null) {</span>
<span class="nc" id="L126">            throw new RedirectException(&quot;DID is null&quot;);</span>
        }
<span class="nc" id="L128">        String didS = (String) di;</span>
<span class="nc" id="L129">        DID did = DID.parse(didS);</span>
<span class="nc" id="L130">        return getAssetByDID(did, remoteAccount);</span>

    }

    /**
     * this methid is used to ge the Asset based on DID and the account.
     *
     * @param did           did of the asset
     * @param remoteAccount user credential
     * @return Asset
     * @throws IOException
     */
    public static Asset getAssetByDID(DID did, RemoteAccount remoteAccount) throws IOException {
<span class="fc" id="L143">        DID agentDID = did.withoutPath();</span>
<span class="fc" id="L144">        String path = did.getPath();</span>
<span class="fc" id="L145">        RemoteAgent remoteAgent = RemoteAgent.connect(agentDID, remoteAccount);</span>
<span class="fc" id="L146">        Asset asset = remoteAgent.getAsset(path);</span>
<span class="fc" id="L147">        return asset;</span>
    }

    /**
     * Creates the &quot;params&quot; part of the invoke payload using the spec in the operation metadata
     * and the passed positional arguments
     *
     * @param operation The operation to format the parameters for
     * @param params    An array of assets to be provided as positional parameters
     * @return The &quot;params&quot; portion of the invoke payload as a JSONObject
     * @throws IllegalArgumentException if missing required parameter
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public
    static Map&lt;String, Object&gt; formatParams(Operation operation, Object... params) {
<span class="nc" id="L162">        HashMap&lt;String, Object&gt; result = new HashMap&lt;&gt;(params.length);</span>
<span class="nc" id="L163">        Map&lt;String, Object&gt; paramSpec = operation.getParamsSpec();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        for (Map.Entry&lt;String, Object&gt; me : paramSpec.entrySet()) {</span>
<span class="nc" id="L165">            String paramName = me.getKey();</span>
<span class="nc" id="L166">            Map&lt;String, Object&gt; spec = (Map&lt;String, Object&gt;) me.getValue();</span>
            // String type=(String) spec.get(&quot;type&quot;);
<span class="nc" id="L168">            Object positionObj = spec.get(&quot;position&quot;);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            int pos = (positionObj != null) ? Utils.coerceInt(positionObj) : -1;</span>
<span class="nc" id="L170">            boolean required = Utils.coerceBoolean(spec.get(&quot;required&quot;));</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">            if ((pos &gt;= 0) &amp;&amp; (pos &lt; params.length)) {</span>
                // TODO: Handle non-asset parameters?
<span class="nc" id="L173">                Asset a = (Asset) params[pos];</span>
<span class="nc" id="L174">                Map&lt;String, Object&gt; value = a.getParamValue();</span>
<span class="nc" id="L175">                result.put(paramName, value);</span>
            }
<span class="nc bnc" id="L177" title="All 2 branches missed.">            if (required) {</span>
<span class="nc" id="L178">                throw new IllegalArgumentException(&quot;Parameter &quot; + paramName + &quot; is required but not supplied&quot;);</span>
            }
<span class="nc" id="L180">        }</span>
<span class="nc" id="L181">        return result;</span>
    }

    /**
     * Converts an array of positional parameters to a map of named parameters, according to the
     * parameter spec of the given operation.
     *
     * @param operation need to get the meta data
     * @param params    all asset on which the validation need to be done
     * @return A new map containing the named parameters
     * @throws IllegalArgumentException if a require dparameter is not provided
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public
    static Map&lt;String, Object&gt; namedParams(Operation operation, Object... params) {
<span class="nc" id="L196">        HashMap&lt;String, Object&gt; result = new HashMap&lt;&gt;(params.length);</span>
<span class="nc" id="L197">        Map&lt;String, Object&gt; paramSpec = operation.getParamsSpec();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">        for (Map.Entry&lt;String, Object&gt; me : paramSpec.entrySet()) {</span>
<span class="nc" id="L199">            String paramName = me.getKey();</span>
<span class="nc" id="L200">            Map&lt;String, Object&gt; spec = (Map&lt;String, Object&gt;) me.getValue();</span>
<span class="nc" id="L201">            Object positionObj = spec.get(&quot;position&quot;);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            int pos = (positionObj != null) ? Utils.coerceInt(positionObj) : -1;</span>
<span class="nc" id="L203">            boolean required = Utils.coerceBoolean(spec.get(&quot;required&quot;));</span>
<span class="nc bnc" id="L204" title="All 4 branches missed.">            if ((pos &gt;= 0) &amp;&amp; (pos &lt; params.length)) {</span>
                // TODO: handle non-asset parameters&gt;
<span class="nc" id="L206">                Asset a = (Asset) params[pos];</span>
<span class="nc" id="L207">                result.put(paramName, a);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">            } else if (required) {</span>
<span class="nc" id="L209">                throw new IllegalArgumentException(&quot;Parameter &quot; + paramName + &quot; is required but not supplied&quot;);</span>
            }
<span class="nc" id="L211">        }</span>
<span class="nc" id="L212">        return result;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>